/*
 SignaturePad: A jQuery plugin for assisting in the creation of an HTML5 canvas
 based signature pad. Records the drawn signature in JSON for later regeneration.

 *************  MODIFIED TO MAKE THE DISABLE FUNCTION PUBLIC **************
 **************  MODIFIED TO WORK WITH EXPLORERCANVAS ON IE8 **************
 Dependencies: excanvas, json2.js, jQuery/1.3.2+

 @project ca.thomasjbradley.applications.signaturepad
 @author Thomas J Bradley <hey@thomasjbradley.ca>
 @link http://thomasjbradley.ca/lab/signature-pad
 @link http://github.com/thomasjbradley/signature-pad
 @copyright Copyright MMXI, Thomas J Bradley
 @license New BSD License
 @version {{version}}
 */
(function(b){function t(l,k){function q(d,b){var c,i;clearTimeout(n);n=!1;"undefined"!==typeof d.changedTouches?(c=Math.floor(d.changedTouches[0].pageX-u),i=Math.floor(d.changedTouches[0].pageY-v)):(c=Math.floor(d.pageX-u),i=Math.floor(d.pageY-v));if(g.x===c&&g.y===i)return!0;null===g.x&&(g.x=c);null===g.y&&(g.y=i);b&&(i+=b);e.beginPath();e.moveTo(g.x,g.y);e.lineTo(c,i);e.lineCap=a.penCap;e.stroke();e.closePath();j.push({lx:c,ly:i,mx:g.x,my:g.y});g.x=c;g.y=i}function m(){r?f.each(function(){this.removeEventListener("touchmove",
  q)}):f.unbind("mousemove.signaturepad");g.x=null;g.y=null;a.output&&0<j.length&&b(a.output,c).val(JSON.stringify(j))}function s(){m();e.clearRect(0,0,h.width,h.height);e.fillStyle=a.bgColour;e.fillRect(0,0,h.width,h.height);a.displayOnly||a.lineWidth&&(e.beginPath(),e.lineWidth=a.lineWidth,e.strokeStyle=a.lineColour,e.moveTo(a.lineMargin,a.lineTop),e.lineTo(h.width-a.lineMargin,a.lineTop),e.stroke(),e.closePath());e.lineWidth=a.penWidth;e.strokeStyle=a.penColour;b(a.output,c).val("");j=[]}function z(d){r?
  f.each(function(){this.addEventListener("touchmove",q,!1)}):f.bind("mousemove.signaturepad",q);q(d,1)}function A(){w=!1;f.each(function(){this.removeEventListener&&(this.removeEventListener("touchend",m),this.removeEventListener("touchcancel",m),this.removeEventListener("touchmove",q));this.ontouchstart&&(this.ontouchstart=null)});f.unbind("mousedown.signaturepad");f.unbind("mouseup.signaturepad");f.unbind("mousemove.signaturepad");f.unbind("mouseleave.signaturepad");b(a.clear,c).unbind("click.signaturepad")}
  function B(d){if(w)return!1;w=!0;b("input").blur();"undefined"!==typeof d.changedTouches&&(r=!0);r?(f.each(function(){this.addEventListener("touchend",m,!1);this.addEventListener("touchcancel",m,!1)}),f.unbind("mousedown.signaturepad")):(f.bind("mouseup.signaturepad",function(){m()}),f.bind("mouseleave.signaturepad",function(){n||(n=setTimeout(function(){m();clearTimeout(n);n=!1},500))}),f.each(function(){this.ontouchstart=null}))}function x(){b(a.typed,c).hide();s();f.each(function(){this.ontouchstart=
    function(d){d.preventDefault();B(d);z(d,this)}});f.bind("mousedown.signaturepad",function(d){u=b(this).offset().left;v=b(this).offset().top;B(d);z(d,this)});b(a.clear,c).bind("click.signaturepad",function(d){d.preventDefault();s()});b(a.typeIt,c).bind("click.signaturepad",function(d){d.preventDefault();C()});b(a.drawIt,c).unbind("click.signaturepad");b(a.drawIt,c).bind("click.signaturepad",function(d){d.preventDefault()});b(a.typeIt,c).removeClass(a.currentClass);b(a.drawIt,c).addClass(a.currentClass);
    b(a.sig,c).addClass(a.currentClass);b(a.typeItDesc,c).hide();b(a.drawItDesc,c).show();b(a.clear,c).show()}function C(){s();A();b(a.typed,c).show();b(a.drawIt,c).bind("click.signaturepad",function(d){d.preventDefault();x()});b(a.typeIt,c).unbind("click.signaturepad");b(a.typeIt,c).bind("click.signaturepad",function(d){d.preventDefault()});b(a.output,c).val("");b(a.drawIt,c).removeClass(a.currentClass);b(a.typeIt,c).addClass(a.currentClass);b(a.sig,c).removeClass(a.currentClass);b(a.drawItDesc,c).hide();
    b(a.clear,c).hide();b(a.typeItDesc,c).show()}function D(d){for(b(a.typed,c).html(d.replace(/>/g,"&gt;").replace(/</g,"&lt;"));b(a.typed,c).width()>h.width;)d=b(a.typed,c).css("font-size").replace(/px/,""),b(a.typed,c).css("font-size",d-1+"px")}function t(d,a){b("p."+a.errorClass,d).remove();d.removeClass(a.errorClass);b("input, label",d).removeClass(a.errorClass)}function F(a,c,e){a.nameInvalid&&(c.prepend(['<p class="',e.errorClass,'">',e.errorMessage,"</p>"].join("")),b(e.name,c).focus(),b(e.name,
    c).addClass(e.errorClass),b("label[for="+b(e.name).attr("id")+"]",c).addClass(e.errorClass));a.drawInvalid&&c.prepend(['<p class="',e.errorClass,'">',e.errorMessageDraw,"</p>"].join(""))}function y(){var d=!0,e={drawInvalid:!1,nameInvalid:!1},f=[c,a],i=[e,c,a];a.onBeforeValidate&&"function"===typeof a.onBeforeValidate?a.onBeforeValidate.apply(p,f):t.apply(p,f);a.drawOnly&&1>j.length&&(e.drawInvalid=!0,d=!1);""===b(a.name,c).val()&&(e.nameInvalid=!0,d=!1);a.onFormError&&"function"===typeof a.onFormError?
    a.onFormError.apply(p,i):F.apply(p,i);return d}function E(d,b,c){for(var e in d)"object"===typeof d[e]&&(b.beginPath(),b.moveTo(d[e].mx,d[e].my),b.lineTo(d[e].lx,d[e].ly),b.lineCap=a.penCap,b.stroke(),b.closePath(),c&&j.push({lx:d[e].lx,ly:d[e].ly,mx:d[e].mx,my:d[e].my}))}var p=this,a=b.extend({},b.fn.signaturePad.defaults,k),c=b(l),f=b(a.canvas,c),u=0,v=0,h=f.get(0),e=null,g={x:null,y:null},j=[],n=!1,r=!1,w=!1;b.extend(p,{init:function(){if(4.1>parseFloat((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent)||
    [0,"4_2"])[1].replace("_",".")))b.fn.Oldoffset=b.fn.offset,b.fn.offset=function(){var a=b(this).Oldoffset();a.top-=window.scrollY;a.left-=window.scrollX;return a};b(a.typed,c).bind("selectstart.signaturepad",function(a){return b(a.target).is(":input")});f.bind("selectstart.signaturepad",function(a){return b(a.target).is(":input")});!h.getContext&&G_vmlCanvasManager&&G_vmlCanvasManager.initElement(h);h.getContext&&(e=h.getContext("2d"),b(a.sig,c).show(),a.displayOnly||(a.drawOnly||(b(a.name,c).bind("keyup.signaturepad",
    function(){D(b(this).val())}),b(a.name,c).bind("blur.signaturepad",function(){D(b(this).val())}),b(a.drawIt,c).bind("click.signaturepad",function(a){a.preventDefault();x()})),a.drawOnly||"drawIt"===a.defaultAction?x():C(),a.validateFields&&(b(l).is("form")?b(l).bind("submit.signaturepad",function(){return y()}):b(l).parents("form").bind("submit.signaturepad",function(){return y()})),b(a.sigNav,c).show()))},updateOptions:function(d){b.extend(a,d)},regenerate:function(d){p.clearCanvas();b(a.typed,c).hide();
    "string"===typeof d&&(d=JSON.parse(d));E(d,e,!0);a.output&&0<b(a.output,c).length&&b(a.output,c).val(JSON.stringify(j))},clearCanvas:function(){s()},disableCanvas:function(){A()},getSignature:function(){return j},getSignatureString:function(){return JSON.stringify(j)},getSignatureImage:function(){var b=document.createElement("canvas"),c=null,c=null;b.style.position="absolute";b.style.top="-999em";b.width=h.width;b.height=h.height;document.body.appendChild(b);!b.getContext&&G_vmlCanvasManager&&G_vmlCanvasManager.initElement(b);
    c=b.getContext("2d");c.fillStyle=a.bgColour;c.fillRect(0,0,h.width,h.height);c.lineWidth=a.penWidth;c.strokeStyle=a.penColour;E(j,c);c=b.toDataURL.apply(b,arguments);document.body.removeChild(b);return c},validateForm:function(){return y()}})}b.fn.signaturePad=function(l){var k=null;this.each(function(){b.data(this,"plugin-signaturePad")?(k=b.data(this,"plugin-signaturePad"),k.updateOptions(l)):(k=new t(this,l),k.init(),b.data(this,"plugin-signaturePad",k))});return k};b.fn.signaturePad.defaults=
{defaultAction:"typeIt",displayOnly:!1,drawOnly:!1,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:!0,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document",
  onBeforeValidate:null,onFormError:null}})(jQuery);